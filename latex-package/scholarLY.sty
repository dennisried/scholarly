\ProvidesPackage{scholarLY}

\RequirePackage{ifthen}
\RequirePackage{keyval}
\RequirePackage{enumitem}
\RequirePackage{xstring}
\RequirePackage{stringstrings}
\RequirePackage{verbatim}% for comments
\RequirePackage{titlecaps}% for custom names


\begin{comment}
~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
compiles with:
\pdflatex? YES
\lualatex? YES
\xelatex?

% TODO:
- parse custom annotation names
- prevent ann message breaking?
- consider reorganizing package structure (this file master, with subfiles)
- support any kind of expansion to custom formats
- provide labels (which can be easily redefined) for user-customized templates
- messages not accepting `uppercase`, though other message styles working.
- support not-yet-defined footnote names
- postannType; vspace (after) doesn't behave as expected
- check need for titlecap in custom annotation names
~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
\end{comment}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% OPTIONS ... the customizable part of the package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Some options can be applied by wrapping the \annotations{filename.annotations.inp} in
% respective environment, such as {multicols}, {xcolor}, etc.
%
% If specific changes are made to items within the text of the actual .inp lists (written
% by the user in the LilyPond document), they will override wrappers as applicable.


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ GLOBAL STYLING OPTIONS ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% style predicates:

\newcommand{\annType}{} % Annotation Type; just italics
\newcommand{\annMeasure}{} % just bold
\newcommand{\annBeat}{} % none
\newcommand{\annVoice}{} % none ; this is Voice or Instrument (e.g. Viola)
\newcommand{\annAffected}{} % none
\newcommand{\annMessage}{} % none
\newcommand{\annFootnote}{} % none

% To update styles:

\newcommand{\styleAnnType}[1]{\renewcommand{\annType}[1]{#1}}
\newcommand{\styleAnnMeasure}[1]{\renewcommand{\annMeasure}[1]{#1}}
\newcommand{\styleAnnBeat}[1]{\renewcommand{\annBeat}[1]{#1}}
\newcommand{\styleAnnVoice}[1]{\renewcommand{\annVoice}[1]{#1}}
\newcommand{\styleAnnAffected}[1]{\renewcommand{\annAffected}[1]{#1}}
\newcommand{\styleAnnMessage}[1]{\renewcommand{\annMessage}[1]{#1}}
\newcommand{\styleAnnFootnote}[1]{\renewcommand{\annFootnote}[1]{#1}}
%
% ex: \styleAnnType{\textit{#1}}


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ DRAFT or FINAL MODE, and styling therein ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~


% create custom settings for `draft` mode:

\newcommand{\customdraft}{}
\newcommand\setcustomdraft[1]{\renewcommand{\customdraft}{#1}}
  \setcustomdraft{
    \styleAnnMessage{##1}
  } % the default settings for DRAFT mode = nothing

\def\customdraftornot{}
\newcommand{\usecustomdraft}{\def\customdraftornot{\customdraft}}


% create custom settings for `final` mode:

\newcommand{\customfinal}{}
\newcommand\setcustomfinal[1]{\renewcommand{\customfinal}{#1}}
  \setcustomfinal{
    \styleAnnMessage{##1}
    \styleAnnMeasure{\color{red}{\textit{##1}}}
  } % the default settings for FINAL mode (just example for now; make bland later)

\def\customfinalornot{}
\newcommand{\usecustomfinal}{\def\customfinalornot{\customfinal}} % apply custom


% let custom final settings carry over to draft mode

\newcommand{\finalfordraft}{\renewcommand{\customdraft}{\customfinal}}


% break annotations or not:

\newcommand{\letAnnBreakornot}{\par\nobreak} % default = no break
\newcommand{\letAnnBreak}{\renewcommand{\letAnnBreakornot}{\par}} % let break
\newcommand{\avoidAnnBreak}{\renewcommand{\letAnnBreakornot}{\par\nobreak}} % avoid break
%
% NOTE If \enumoptions (see below) specifies vertical spacing within items, \letAnnBreak
%      is more likely to result in breaks. Otherwise, LaTeX will try to avoid breaking
%      even with \letAnnBreak employed.


% inline or stacked annotations:

\newcommand{\skipornot}{}
\newcommand{\typeSkipornot}{}

\newcommand{\inlineParams}{%
  \renewcommand{\skipornot}{, }
}

\newcommand{\stackedParams}{%
  \renewcommand{\skipornot}{\letAnnBreakornot}
}


% custom type name . stub
\define@key{scholarLYannotations}{type}{\def\lytype{#1}}


% hide or show annotation types:

\newcommand{\hideAnnTypes}{%
  \renewcommand{\CRname}{}
  \renewcommand{\MIname}{}
  \renewcommand{\LIname}{}
  \renewcommand{\Qname}{}
  \renewcommand{\TDname}{}
  \def\customName{}
  \renewcommand{\typeSkipornot}{}
}

\newcommand{\showAnnTypes}{%
  \renewcommand{\CRname}{\annType{(Critical Remark) }} % if the user defines a ','
  \renewcommand{\MIname}{\annType{(Musical Issue) }}   % for \postannType, they must
  \renewcommand{\LIname}{\annType{(LilyPond Issue) }}  % also \unskip to remove the
  \renewcommand{\Qname}{\annType{(Question) }}         % cushion here.
  \renewcommand{\TDname}{\annType{(To Do) }}
  \def\customName{\lytype}% TODO this actually needs to be parsed
}

\newcommand{\annStyleMode}{}


% declare draft/final options:

\newif\ifex@draft % (implicitly final) ... i.e. draft mode if set, otherwise final mode,
                  % which can also be explicitly set: \usepackage[final]{scholarLY}

\DeclareOption{draft}{\ex@drafttrue}
\DeclareOption{final}{\ex@draftfalse}
\ProcessOptions*

\ifex@draft
  \stackedParams % default, can be overwritten in custom or global settings
  \newcommand{\CRname}{\annType{(Critical Remark) }}
  \newcommand{\MIname}{\annType{(Musical Issue) }}
  \newcommand{\LIname}{\annType{(LilyPond Issue) }}
  \newcommand{\Qname}{\annType{(Question) }}
  \newcommand{\TDname}{\annType{(TODO) }}
  \renewcommand{\annStyleMode}{\customdraftornot}% must be *last*
\else
  \inlineParams % default, can be overwritten in custom or global settings
  \newcommand{\CRname}{\annType{}}
  \newcommand{\MIname}{\annType{}}
  \newcommand{\LIname}{\annType{}}
  \newcommand{\Qname}{\annType{}}
  \newcommand{\TDname}{\annType{}}
  \renewcommand{\annStyleMode}{\customfinalornot}% must be *last*
\fi


%% ~ ~ ~ ADDITIONAL CUSTOMIZATIONS ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% apply any of the usual enumerate arguments to the list:

\newcommand{\enumOptions}{}
\newcommand{\setEnumOptions}[1]{\renewcommand{\enumOptions}{#1}}


% do something immediately after the type (only effective if type present)

\newcommand{\postannType}{} % add vspace, hspace, characters, etc. *after* type
\newcommand{\setpostannType}[1]{\renewcommand{\postannType}{#1}}
%
% NOTE: add \par to correct vspace behavior, i.e. \setpostannType{\par\vspace{1cm}}


% do something immediately before each of the arguments (presently affects all):

\def\preannType{}
\newcommand{\setpreannType}[1]{\def\preannType{#1}}
\def\preannArg{}
\newcommand{\setpreannArg}[1]{\def\preannArg{#1}}


% {prependFirst}{prepend} (MESSAGE) {append} {appendLast}:

\def\prependMessageFirst{}
\def\prependMessage{``} % default
\def\appendMessage{''} % default
\def\appendMessageLast{}
% user commands:
\newcommand{\setPreMessFirst}[1]{\def\prependMessageFirst{\unskip#1}}
\newcommand{\setPreMess}[1]{\def\prependMessage{#1\unskip}}
\newcommand{\setAppMess}[1]{\def\appendMessage{\unskip#1\unskip}}
\newcommand{\setAppMessLast}[1]{\def\appendMessageLast{\unskip#1\unskip}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ENVIRONMENTS and COMMANDS ... the main part of the package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% ~ ~ ~ ALLOW (default) or AVOID breaking arguments in annotations ~ ~ ~ ~ ~ ~

% TODO - find a better solution?

% Currently, \skipornot (the main breaking toggle) = {\par\nobreak} when set to
% skip, which does protect from breaking. But rather than stretching/squeezing
% the lines, it rounds down (if necessary) and pulls the footnotes (if any) up.

% the following *will* toggle breaking allowance/avoidance
% ex: \letAnnBreak


%% ~ ~ ~ \annotations = the main command ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\newcommand{\annotations}[1]
{\begin{enumerate}[mode=boxed]\enumOptions\annStyleMode\input{#1}\end{enumerate}}
%
% ex: \annotations{annotate.annotations.inp}


%% ~ ~ ~ KEY / VALUE arguments ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\define@key{scholarLYannotations}{grob}{\edef\lygrob{\detokenize{#1}}}
\define@key{scholarLYannotations}{grob-location}{\edef\lygroblocation{\detokenize{#1}}}
\define@key{scholarLYannotations}{grob-type}{\def\lygrobtype{#1}}
\define@key{scholarLYannotations}{input-file-name}{\def\lyinputfilename{#1}}
\define@key{scholarLYannotations}{context-id}{\def\lycontextid{#1}}
\define@key{scholarLYannotations}{location}{\edef\lylocation{\detokenize{#1}}}
\define@key{scholarLYannotations}{message}{\def\lymessage{#1}}
\define@key{scholarLYannotations}{context}{\def\lycontext{#1}}
\define@key{scholarLYannotations}{fn-one-text}{\def\lyfnonetext{#1}}
\define@key{scholarLYannotations}{fn-two-text}{\def\lyfntwotext{#1}}
\define@key{scholarLYannotations}{fn-three-text}{\def\lyfnthreetext{#1}}
\define@key{scholarLYannotations}{fn-four-text}{\def\lyfnfourtext{#1}}
\define@key{scholarLYannotations}{fn-five-text}{\def\lyfnfivetext{#1}}
\define@key{scholarLYannotations}{ann-footnote}{\def\lyannfootnote{#1}}

\setkeys{scholarLYannotations}{% default values
  grob = no value given,
  grob-location = no value given,
  grob-type = no value given,
  input-file-name = no value given,
  context-id = no value given,
  location = no value given,
  type = no value given,
  message = no value given,
  context = no value given,
  fn-one-text = {\color{red} Oops! Nothing has been entered for this footnote.},
  fn-two-text = {\color{red} Oops! Nothing has been entered for this footnote.},
  fn-three-text = {\color{red} Oops! Nothing has been entered for this footnote.},
  fn-four-text = {\color{red} Oops! Nothing has been entered for this footnote.},
  fn-five-text = {\color{red} Oops! Nothing has been entered for this footnote.},
  ann-footnote = {no value given}
}

\def\resetkeys{
  \setkeys{scholarLYannotations}{% default values
    grob = no value given,
    grob-location = no value given,
    grob-type = no value given,
    input-file-name = no value given,
    context-id = no value given,
    location = no value given,
    type = no value given,
    message = no value given,
    context = no value given,
    fn-one-text = {\color{red} Oops! Nothing has been entered for this footnote.},
    fn-two-text = {\color{red} Oops! Nothing has been entered for this footnote.},
    fn-three-text = {\color{red} Oops! Nothing has been entered for this footnote.},
    fn-four-text = {\color{red} Oops! Nothing has been entered for this footnote.},
    fn-five-text = {\color{red} Oops! Nothing has been entered for this footnote.},
    ann-footnote = {no value given}
  }
}


\def\noMessError{\color{red} Oops! No message has been entered for this annotation.}


%% ~ ~ ~ more TOGGLES ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% commands for linking footnotes to text
% NOTE - marks/text are only linked to their respective partners
% (suffixes `One`, `Two`, etc. aren't don't influence the actual order)

\def\fnOne{\unskip\footnote{\lyfnonetext} }
\def\fnTwo{\unskip\footnote{\lyfntwotext} }
\def\fnThree{\unskip\footnote{\lyfnthreetext} }
\def\fnFour{\unskip\footnote{\lyfnfourtext} }
\def\fnFive{\unskip\footnote{\lyfnfivetext} }


% default prefixes/names:
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
% These allow user to pull labels and content easily for use in custom templates.
% Of course, others can be defined just the same. These are provided for convenience,
% and for easily mapping into the provided templates. (So far, only `default` exists.)
%
\def\lygrobPfx{}
\def\lygroblocationPfx{}
\def\lygrobtypePfx{}
\def\lyinputfilenamePfx{}
\def\lycontextidPfx{}
\def\lylocationPfx{}
\def\lytypePfx{}
\def\lymessagePfx{}
\def\lycontextPfx{}
% extras used in default template:
\def\lymeasurePfx{M.} % default; user resets: \def\lymessagePfx{(something else)}
\def\lybeatPfx{beat }

% One could combine such as:
%     \lylocationPfx : \lymeasurePfx {#2} \lybeatPfx {#3}
%
% TODO let #2 and #3 be mapped to \lymeasure and \lybeat, updated in each annotation,
% to be used such as:
%     \lylocationPfx : \lymeasurePfx\lymeasurelybeatPfx\lybeat
%
% another ex:
%     \def\lygrobPrx{custom name}
%     \lygrobPfx:\hspace{1em}\lygrob


% if same measure, optionally substitute:

\def\previousMeasure{0} % default
\def\sameMeasureStub{---}
\def\sameMeasure{\sameMeasureStub} % user may redefine sameMeasureStub
\def\currentMeasure{0} % default
\newcommand{\verboseMeasures}{\def\sameMeasure{\lymeasurePfx\currentMeasure,}}
% \verboseMeasures = makes measures always show


% optionally substitute same beat (if *also* same measure):

\def\previousBeat{0}
\def\sameBeatStub{{---}\unskip}
\def\sameBeat{\sameBeatStub}
\def\currentBeat{0}
\newcommand{\verboseBeats}{\def\sameBeat{\lybeatPfx\currentBeat}}
% \verboseBeats = make beats always show


\ifthenelse{\equal{\sameMeasure}{\lymeasurePfx\currentMeasure,}}% if verbose measures
  %true
  {\ifthenelse{\equal{\currentBeat}{\previousBeat}}% if current beat = previous beat
    %true
    {\ifthenelse{\equal{\sameBeat}{\lybeatPfx\currentBeat}}% if verbose beats
      %true
      {\def\sameBeat{\currentBeat}}% then, beats always = current beat
      %false
      {\def\sameBeat{\sameBeatStub}}}% else, same beats = stub
    %false
    {}}% do nothing.. current beat displayed always
  %false
  {}% else nothing


%% ~ ~ ~ the PARSERS ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% test the message for punctuations, and store the result:

\def\annMessagePunct{}% default, no punctuation

\newcommand{\testMessagePunct}{%
  \saveexpandmode\expandarg
    \IfEndWith{\lymessage}{.}
      % true
      {\def\annMessagePunct{.}}
      % false
      {\IfEndWith{\lymessage}{?}
        % true
        {\def\annMessagePunct{?}}
        % false
        {\IfEndWith{\lymessage}{!}
          % true
          {\def\annMessagePunct{!}}
          % false
          {\def\annMessagePunct{\unskip}}
        }
      }
  \restoreexpandmode
}


% parse messages:
% TODO unskip ONLY if prependMessage is NOT equal to {}? Make user set that?

\newcommand{\annMessageParse}{%
  \saveexpandmode\expandarg
    \IfEndWith{\lymessage}{.}
      % true; the user set a period for punctuation
      {\unskip\StrGobbleRight{\lymessage}{1}\nobreak}
      % false
      {\IfEndWith{\lymessage}{?}
        % true; the user set a question mark for punctuation
        {\unskip\StrGobbleRight{\lymessage}{1}\nobreak}
        % false
        {\IfEndWith{\lymessage}{!}
          % true; the user set an exclamation point for punctuation
          {\unskip\StrGobbleRight{\lymessage}{1}\nobreak}
          % false
          {\ifthenelse{\equal{\lymessage}{no value given}}{\unskip\noMessError}
            % else
            {\ifthenelse{\equal{\lymessage}{}}{\unskip\noMessError}
              % else
              {\unskip{\lymessage}\nobreak}}}
        }
      }
  \restoreexpandmode
}


% set the append/punct vs. punct/append orientations:

\newcommand{\annMessTail}{\annMessagePunct\appendMessage} % default = Punct, Append

\newcommand{\annMessPunctAppend}{%
  \renewcommand{\annMessTail}{\annMessagePunct\unskip\appendMessage}} % Append, Punct

\newcommand{\annMessAppendPunct}{%
  \renewcommand{\annMessTail}{\appendMessage\unskip\annMessagePunct}} % Punct, Append


% generic annotation, custom type: name parser
\def\customName{
  \StrCut{\lyanntype}{-}\csA\csB% remove first hyphen, if one
  \def\expandedonce{\csA{} \csB}
    \StrCut{\expandedonce}{-}\csC\csD% remove second hyphen, if two
    \def\expandedtwice{\csC{} \csD}
      \StrCut{\expandedtwice}{-}\csE\csF% remove third hyphen, if three
  \titlecap{\csE{} \csF}% result
}


% default annotation parsers: for stacked and inline modes that can be easily
% hacked/reconfigured to custom designs.

\newcommand{\criticalRemark}[6][]{%
\saveexpandmode\expandarg
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
    \def\currentMeasure{#2}
    \def\currentBeat{#3}
      \item{\preannType\lytypePfx\CRname\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

\newcommand{\musicalIssue}[6][]{%
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
  \def\currentMeasure{#2}
  \def\currentBeat{#3}
      \item{\preannType\lytypePfx\MIname\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

\newcommand{\lilypondIssue}[6][]{%
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
  \def\currentMeasure{#2}
  \def\currentBeat{#3}
      \item{\preannType\lytypePfx\LIname\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

\newcommand{\question}[6][]{%
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
  \def\currentMeasure{#2}
  \def\currentBeat{#3}
      \item{\preannType\lytypePfx\Qname\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

\newcommand{\todo}[6][]{%
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
  \def\currentMeasure{#2}
  \def\currentBeat{#3}
      \item{\preannType\lytypePfx\TDname\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

\newcommand{\annotation}[6][]{% generic annotation, for custom types
\resetkeys
  \setkeys{scholarLYannotations}{#1}
  \testMessagePunct
  \def\currentMeasure{#2}
  \def\currentBeat{#3}
      \item{\preannType\lytypePfx\customName\postannType\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure}}
        {\preannArg\lylocationPfx{\annMeasure{\lymeasurePfx#2,}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat\skipornot}
            {\annBeat{\lybeatPfx#3}\skipornot}}}
        {\annBeat{\lybeatPfx#3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}
        {\preannArg\lycontextPfx\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}
        {\preannArg\lygrobtypePfx\annAffected{#5}\skipornot}
      \preannArg\lymessagePfx{\annMessage{{%
        \prependMessageFirst\prependMessage\annMessageParse\unskip\annMessTail}\unskip}
      \ifthenelse{\equal{\lyannfootnote}{no value given}}{}
        {\unskip\annFootnote{\footnote{\lyannfootnote}}}\appendMessageLast}}
    \def\previousMeasure{#2}
    \def\previousBeat{#3}
}

% for custom annotations // TODO this is a stub
\newcommand{\lyannotations}[2][]{% ``lee-annotations''
  \IfSubStr{#1}{option}{%
    \IfSubStr{#1}{second}{the result of both}{just the first}}
    {\IfSubStr{#1}{second}{just the second}{nothing satisfied}}
#2
}

\endinput
