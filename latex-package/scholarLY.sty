\ProvidesPackage{scholarLY}

\RequirePackage{verbatim}
\RequirePackage{ifthen}
\RequirePackage{keyval}
\RequirePackage{enumitem}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% OPTIONS ... the customizable part of the package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Some options can be applied by wrapping the \annotations{filename.annotations.inp} in
% respective environment, such as {multicols}, {xcolor}, etc.
%
% If specific changes are made to items within the text of the actual .inp lists (written
% by the user in the LilyPond document), they will override wrappers as applicable.


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ GLOBAL STYLING OPTIONS ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% DEFAULTS in final
\newcommand{\annType}[1]{#1} % Annotation Type; just italics
\newcommand{\annMeasure}[1]{#1} % just bold
\newcommand{\annBeat}[1]{#1} % none
\newcommand{\annVoice}[1]{#1} % none ; this is Voice or Instrument (e.g. Viola)
\newcommand{\annAffected}[1]{#1} % none
\newcommand{\annMessage}[1]{#1} % none
\newcommand{\annFootnote}[1]{#1} % none

% To update styles:
\newcommand{\styleAnnType}[1]{\renewcommand{\annType}[1]{#1}}
\newcommand{\styleAnnMeasure}[1]{\renewcommand{\annMeasure}[1]{#1}}
\newcommand{\styleAnnBeat}[1]{\renewcommand{\annBeat}[1]{#1}}
\newcommand{\styleAnnVoice}[1]{\renewcommand{\annVoice}[1]{#1}}
\newcommand{\styleAnnAffected}[1]{\renewcommand{\annAffected}[1]{#1}}
\newcommand{\styleAnnMessage}[1]{\renewcommand{\annMessage}[1]{#1}}
\newcommand{\styleAnnFootnote}[1]{\renewcommand{\annFootnote}[1]{#1}}
%
% ex: \styleAnnType{\textit{#1}}


% DEFAULTS for draft
\newcommand{\annTypeDraft}[1]{#1} % Annotation Type; just italics
\newcommand{\annMeasureDraft}[1]{#1} % just bold
\newcommand{\annBeatDraft}[1]{#1} % none
\newcommand{\annVoiceDraft}[1]{#1} % none ; this is Voice or Instrument (e.g. Viola)
\newcommand{\annAffectedDraft}[1]{#1} % none
\newcommand{\annMessageDraft}[1]{#1} % none
\newcommand{\annFootnoteDraft}[1]{#1} % none

% To update styles:
\newcommand{\styleAnnTypeDraft}[1]{\renewcommand{\annTypeDraft}[1]{#1}}
\newcommand{\styleAnnMeasureDraft}[1]{\renewcommand{\annMeasureDraft}[1]{#1}}
\newcommand{\styleAnnBeatDraft}[1]{\renewcommand{\annBeatDraft}[1]{#1}}
\newcommand{\styleAnnVoiceDraft}[1]{\renewcommand{\annVoiceDraft}[1]{#1}}
\newcommand{\styleAnnAffectedDraft}[1]{\renewcommand{\annAffectedDraft}[1]{#1}}
\newcommand{\styleAnnMessageDraft}[1]{\renewcommand{\annMessageDraft}[1]{#1}}
\newcommand{\styleAnnFootnoteDraft}[1]{\renewcommand{\annFootnoteDraft}[1]{#1}}
%

% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ DRAFT or FINAL MODE, and styling therein ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\newcommand{\customdraft}{}
\newcommand\setcustomdraft[1]{\renewcommand{\customdraft}{#1}}
\setcustomdraft{
\styleAnnMessage{##1}
} % the default settings for DRAFT mode
\newcommand{\customdraftornot}{}
\newcommand{\usecustomdraft}{\renewcommand{\customdraftornot}{\customdraft}}

\newcommand{\customfinal}{}
\newcommand\setcustomfinal[1]{\renewcommand{\customfinal}{#1}}
\setcustomfinal{
\styleAnnMessage{##1}
\styleAnnMeasure{\color{red}{\textit{##1}}}
} % the default settings for FINAL mode
\newcommand{\customfinalornot}{}
\newcommand{\usecustomfinal}{\renewcommand{\customfinalornot}{\customfinal}}

\newcommand{\finalfordraft}{\renewcommand{\customdraft}{\customfinal}}

\newif\ifex@draft % (implicitly final) ... i.e. draft mode if set, otherwise final mode,
                  % which can also be explicitly set: \usepackage[final]{scholarLY}

\DeclareOption{draft}{\ex@drafttrue}
\DeclareOption{final}{\ex@draftfalse}
\ProcessOptions*

\ifex@draft
  \newcommand\skipornot{\par}
  \newcommand{\typeSkipornot}{\par}
  \newcommand{\CRname}{\annType{(Critical Remark)}}
  \newcommand{\MIname}{\annType{(Musical Issue)}}
  \newcommand{\LIname}{\annType{(LilyPond Issue)}}
  \newcommand{\Qname}{\annType{(Question)}}
  \newcommand{\TDname}{\annType{(TODO)}}
  \newcommand{\modePostType}{\par}
  \newcommand{\annStyleMode}{\customdraftornot}
\else
  \newcommand{\annStyleMode}{\customfinalornot}
  \newcommand{\modePostType}{, }
  \newcommand{\CRname}{\annType{}}
  \newcommand{\MIname}{\annType{}}
  \newcommand{\LIname}{\annType{}}
  \newcommand{\Qname}{\annType{}}
  \newcommand{\TDname}{\annType{}}
  \newcommand{\typeSkipornot}{}
  \newcommand\skipornot{, } % TODO: leave empty here, add conditional comma for
\fi                         % each parameter (exist if used; none/empty if not)


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ ENUMERATION STYLE  ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%
% This package (currently) uses the 'enumitem' package for listing/formatting
% the annotations. These options can be place at the top of the document (will
% affect the entire document, unless changed) or just before the annotations.
% More info: https://www.ctan.org/pkg/enumerate?lang=en

%%% ONE or TWO PARENS, or other
\renewcommand\labelenumi{\theenumi)}     % This should be easily customizable by
% \renewcommand\labelenumi{(\theenumi)}  % the user. Either recommend in the documentation
                                         % that it can be changed as such, or create an
                                         % abbreviated command for the user.

%%% SPACING, TODO optionally. - put within list via \enumOptions
% \setlist[enumerate]{leftmargin=*} % left-justified (to each margin)
\setlist{parsep=0pt} % spacing between different annotations
\setlength{\parskip}{0em} % line-spacing within each annotation
\setlength{\itemsep}{0pt}


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ FORMAT FOOTNOTES ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% TODO this is a placeholder, pending footnotes functionality in scholarLY
%
% example: ... NOTE: remove this later, after testing
%
% \musicalIssue \with {
%   message = "This is my message\fnOne, and it has two footnotes."
%   fnOneText = "This is the text of the footnote"
%   annotation-footnote = "This automatically tagged to end of message"
% }


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ CONTINUE or RESET FOOTNOTE COUNT ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\newcommand{\lastfootnote}[1]{\setcounter{footnote}{#1}}
\newcommand{\resetfootnotes}{\setcounter{footnote}{0}}
%
\resetfootnotes % default
%
% To manually reset (overriding continuation, if applicable) prepend the
% following to \annotations{filename.annotations.inp} command:
%   \lastfootnote{#}
% To reset the count (at any time):
%   \resetfootnotes
%
% This can be inserted within annotations in the LilyPond document.


% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%% ~ ~ ~ GLOBAL FORMATTING OPTIONS  ~
% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% TODO MULTI-COLUMNs
% multicols package is applicable, as well as (presumably) others; this will be
% verified.
% BUT, make condition to avoid breaking arguments inside an annotation
%
% [twocolumn] option is applicable, but also breaks (allow or avoid?; or optional?)

\newcommand{\postannType}{} % add vspace, hspace, characters, etc. *after* type
% NOTE to user: add \par to correct vspace behavior, i.e. \postannType{\par\vspace{1cm}}
\newcommand{\preannArg}{}

% TODO type or not ... \excludetype will turn \includeornot (in front of 'type'), so
% user can *not* print the types easily, if so desired.
% \newcommand{\excludeType}{\renewcommand{\includeornot}{exclude}}
%
% \ifthenelse{\equal{\includeornot}{exclude}}{}{(Critical Remark)}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ENVIRONMENTS and COMMANDS ... the main part of the package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% format/style the list of annotations
\newcommand{\enumOptions}{}
\newcommand{\setEnumOptions}[1]{\renewcommand{\enumOptions}{#1}}
%
% ex: \setEnumOptions{\setlength{\itemsep}{0.5cm}}


%% ~ ~ ~ \annotations = the main command ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
%
\newcommand{\annotations}[1]
{\begin{enumerate}\enumOptions\annStyleMode\input{#1}\end{enumerate}}
%
% ex: \annotations{annotate.annotations.inp}

%% ~ ~ ~ ALLOW (default) or AVOID breaking arguments in annotations ~ ~ ~ ~ ~ ~
%
% NOTE - this section is not in use. As is, it works for avoiding breaking, but
% corrupts footnotes. TODO - find another solution.

\newcommand{\defaultAnnBreaks}{
  \newcommand{\noAnnBreaksBegin}{}
  \newcommand{\noAnnBreaksEnd}{}
}
\defaultAnnBreaks % allowed; no need to be entered by user, but may be used within an
                % annotation to change behavior inline.

\newcommand{\allowAnnBreaks}{
  \renewcommand{\noAnnBreaksBegin}{}
  \renewcommand{\noAnnBreaksEnd}{}
}

\newcommand{\avoidAnnBreaks}{
  % AVOID annotated breaks, environments
  \newenvironment{absolutelynopagebreak}
    {\par\nobreak\vfil\penalty0\vfilneg
     \vtop\bgroup}
    {\par\xdef\tpd{\the\prevdepth}\egroup
     \prevdepth=\tpd}
  \renewcommand{\noAnnBreaksBegin}{\begin{absolutelynopagebreak}}
  \renewcommand{\noAnnBreaksEnd}{\end{absolutelynopagebreak}}
}
%
% ex: \avoidAnnBreaks

%% ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% The LAST parameter in each set is footnote. If empty, one is not created. If
% other optional parameters are added in the future, these places (#1, #2, etc)
% may shift. Non-defined parameters should always make the list as {}, otherwise
% latex will assume the next argument (whether {} or {argument}) in that place.
%
% Requires annotation type and measure number, all other arguments optional

%% ~ ~ ~ KEY + VALUE arguments ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

% \makeatletter
\define@key{scholarLYannotations}{grob}{\def\lygrob{#1}}
\define@key{scholarLYannotations}{grob-location}{\def\lygroblocation{#1}}
\define@key{scholarLYannotations}{grob-type}{\def\lygrobtype{#1}}
\define@key{scholarLYannotations}{input-file-name}{\def\lyinputfilename{#1}}
\define@key{scholarLYannotations}{context-id}{\def\lycontextid{#1}}
\define@key{scholarLYannotations}{location}{\def\lylocation{#1}}
\define@key{scholarLYannotations}{type}{\def\lytype{#1}}
\define@key{scholarLYannotations}{message}{\def\lymessage{#1}}
\define@key{scholarLYannotations}{context}{\def\lycontext{#1}}
\define@key{scholarLYannotations}{fn-one-text}{\def\lyfnonetext{#1}}
\define@key{scholarLYannotations}{fn-two-text}{\def\lyfntwotext{#1}}
\define@key{scholarLYannotations}{fn-three-text}{\def\lyfnthreetext{#1}}
\define@key{scholarLYannotations}{fn-four-text}{\def\lyfnfourtext{#1}}
\define@key{scholarLYannotations}{fn-five-text}{\def\lyfnfivetext{#1}}
% \makeatother

% \makeatletter
\setkeys{scholarLYannotations}{ % default values
  grob = no value given,
  grob-location = no value given,
  grob-type = no value given,
  input-file-name = no value given,
  context-id = no value given,
  location = no value given,
  type = no value given,
  message = no value given,
  context = no value given,
  fn-one-text = nothing has been entered for this footnote,
  fn-two-text = nothing has been entered for this footnote,
  fn-three-text = nothing has been entered for this footnote,
  fn-four-text = nothing has been entered for this footnote,
  fn-five-text = nothing has been entered for this footnote
    % if user needs more than five footnotes, must create new key=value before \annotations
}
% \makeatother

\newcommand{\resetkeys}{
  % \makeatletter
    \setkeys{scholarLYannotations}{ % default values
      grob = no value given,
      grob-location = no value given,
      grob-type = no value given,
      input-file-name = no value given,
      context-id = no value given,
      location = no value given,
      type = no value given,
      message = no value given,
      context = no value given
      fn-one-text = nothing has been entered for this footnote,
      fn-two-text = nothing has been entered for this footnote,
      fn-three-text = nothing has been entered for this footnote,
      fn-four-text = nothing has been entered for this footnote,
      fn-five-text = nothing has been entered for this footnote
    }
  \makeatother
}

%% ~ ~ ~ hide or show types manually ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\newcommand{\hideAnnTypes}{
  \renewcommand{\typeSkipornot}{}
  \renewcommand{\CRname}{}
  \renewcommand{\MIname}{}
  \renewcommand{\LIname}{}
  \renewcommand{\Qname}{}
  \renewcommand{\TDname}{}
}

\newcommand{\showAnnTypes}{
  \renewcommand{\typeSkipornot}{\modePostType}
  \renewcommand{\CRname}{\annType{(Critical Remark)}}
  \renewcommand{\MIname}{\annType{(Musical Issue)}}
  \renewcommand{\LIname}{\annType{(LilyPond Issue)}}
  \renewcommand{\Qname}{\annType{(Question)}}
  \renewcommand{\TDname}{\annType{(To Do)}}
}

\newcommand{\previousMeasure}{0} % default
\newcommand{\sameMeasure}{---} % user may redefine
\newcommand{\currentMeasure}{0} % default
\newcommand{\verboseMeasures}{\renewcommand{\sameMeasure}{M.\currentMeasure}}
% ex: \verboseMeasures

\newcommand{\previousBeat}{0}
\newcommand{\sameBeat}{{}\unskip}
\newcommand{\currentBeat}{0}
\newcommand{\verboseBeats}{\renewcommand{\sameBeat}{beat \currentBeat,}}
% ex: \verboseBeats

%% ~ ~ ~ the parser commands ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

\newcommand{\criticalRemark}[7][]{
  \resetkeys\setkeys{scholarLYannotations}{#1}
    \renewcommand{\currentMeasure}{#2}
    \renewcommand{\currentBeat}{#3}
      \item{\CRname\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure},}
        {\postannType\preannArg{\annMeasure{M.#2,}}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat}
            {\annBeat{beat #3}\skipornot}}}
        {\annBeat{beat #3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}{\preannArg\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}{\preannArg\annAffected{#5}\skipornot}
      \preannArg{\annMessage{\unskip#6\unskip
      \ifthenelse{\equal{#7}{}}{}{\annFootnote{\footnote{#7}}}}}
    \renewcommand{\previousMeasure}{#2}
    \renewcommand{\previousBeat}{#3}
}

\newcommand{\musicalIssue}[7][]{
  \resetkeys\setkeys{scholarLYannotations}{#1}
    \renewcommand{\currentMeasure}{#2}
    \renewcommand{\currentBeat}{#3}
      \item{\MIname\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure},}
        {\postannType\preannArg{\annMeasure{M.#2,}}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat}
            {\annBeat{beat #3}\skipornot}}}
        {\annBeat{beat #3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}{\preannArg\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}{\preannArg\annAffected{#5}\skipornot}
      \preannArg{\annMessage{\unskip#6\unskip
      \ifthenelse{\equal{#7}{}}{}{\annFootnote{\footnote{#7}}}}}
    \renewcommand{\previousMeasure}{#2}
    \renewcommand{\previousBeat}{#3}
}

\newcommand{\lilypondIssue}[7][]{
  \resetkeys\setkeys{scholarLYannotations}{#1}
    \renewcommand{\currentMeasure}{#2}
    \renewcommand{\currentBeat}{#3}
      \item{\LIname\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure},}
        {\postannType\preannArg{\annMeasure{M.#2,}}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat}
            {\annBeat{beat #3}\skipornot}}}
        {\annBeat{beat #3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}{\preannArg\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}{\preannArg\annAffected{#5}\skipornot}
      \preannArg{\annMessage{\unskip#6\unskip
      \ifthenelse{\equal{#7}{}}{}{\annFootnote{\footnote{#7}}}}}
    \renewcommand{\previousMeasure}{#2}
    \renewcommand{\previousBeat}{#3}
}

\newcommand{\question}[7][]{
  \resetkeys\setkeys{scholarLYannotations}{#1}
    \renewcommand{\currentMeasure}{#2}
    \renewcommand{\currentBeat}{#3}
      \item{\Qname\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure},}
        {\postannType\preannArg{\annMeasure{M.#2,}}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat}
            {\annBeat{beat #3}\skipornot}}}
        {\annBeat{beat #3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}{\preannArg\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}{\preannArg\annAffected{#5}\skipornot}
      \preannArg{\annMessage{\unskip#6\unskip
      \ifthenelse{\equal{#7}{}}{}{\annFootnote{\footnote{#7}}}}}
    \renewcommand{\previousMeasure}{#2}
    \renewcommand{\previousBeat}{#3}
}

\newcommand{\todo}[7][]{
  \resetkeys\setkeys{scholarLYannotations}{#1}
    \renewcommand{\currentMeasure}{#2}
    \renewcommand{\currentBeat}{#3}
      \item{\TDname\typeSkipornot
      \ifthenelse{\equal{#2}{\previousMeasure}}{\annMeasure{\sameMeasure},}
        {\postannType\preannArg{\annMeasure{M.#2,}}}}
      \ifthenelse{\equal{#2}{\previousMeasure}}
        {\ifthenelse{\equal{#3}{}}{\unskip{}}
          {\ifthenelse{\equal{#3}{\previousBeat}}{\sameBeat}
            {\annBeat{beat #3}\skipornot}}}
        {\annBeat{beat #3}\skipornot}
      \ifthenelse{\equal{#4}{}}{\unskip{}}{\preannArg\annVoice{#4}\skipornot}
      \ifthenelse{\equal{#5}{}}{\unskip{}}{\preannArg\annAffected{#5}\skipornot}
      \preannArg{\annMessage{\unskip#6\unskip
      \ifthenelse{\equal{#7}{}}{}{\annFootnote{\footnote{#7}}}}}
    \renewcommand{\previousMeasure}{#2}
    \renewcommand{\previousBeat}{#3}
}

\endinput
